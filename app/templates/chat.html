{% extends "base.html" %}

{% block head %}
<style>
    /* Custom scrollbar */
    .messages::-webkit-scrollbar {
        width: 6px;
    }
    .messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .messages::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    .messages::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-md overflow-hidden">
    <!-- Chat header -->
    <div class="bg-indigo-600 text-white p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-xl font-bold">L</div>
                <div class="ml-3">
                    <h2 class="text-lg font-semibold">Lumi</h2>
                    <p class="text-indigo-100 text-sm">Your AI Companion</p>
                </div>
            </div>
            <!-- API Status Indicator -->
            <div id="api-status" class="flex items-center text-sm cursor-pointer" onclick="checkApiStatus()" title="Click to refresh status">
                <div class="w-2 h-2 rounded-full bg-gray-400 mr-1" id="status-dot"></div>
                <span id="status-text">Checking...</span>
                <svg class="w-3 h-3 ml-1 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
            </div>
        </div>
    </div>
    
    <!-- Messages container -->
    <div class="chat-container flex flex-col p-4">
        <div id="messages" class="messages space-y-4 mb-4">
            <!-- Messages will be loaded here by JavaScript -->
        </div>
        
        <!-- Typing indicator (hidden by default) -->
        <div id="typing-indicator" class="hidden mb-4 ml-2">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ml-2 bg-gray-100 rounded-lg px-4 py-2 text-gray-700">
                    <span class="typing-indicator"></span>
                </div>
            </div>
        </div>
        
        <!-- Message input -->
        <div class="mt-auto">
            <form id="message-form" class="flex space-x-2">
                <input 
                    type="text" 
                    id="message-input" 
                    placeholder="Type your message..." 
                    class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    autocomplete="off"
                >
                <button 
                    type="submit" 
                    class="bg-indigo-600 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Load chat history and initialize the chat -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messagesContainer = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const typingIndicator = document.getElementById('typing-indicator');
        
        // Function to add a message to the chat
        function addMessage(role, content, timestamp = null) {
            const messageDiv = document.createElement('div');
            const time = timestamp ? new Date(timestamp) : new Date();
            const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Format message based on role (user or assistant)
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex justify-end mb-2">
                        <div class="max-w-xs md:max-w-md lg:max-w-lg xl:max-w-xl bg-indigo-100 text-gray-800 rounded-2xl px-4 py-2">
                            <p class="text-sm">${content}</p>
                            <p class="text-xs text-gray-500 text-right mt-1">${timeString}</p>
                        </div>
                        <div class="ml-2 w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex mb-2">
                        <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="ml-2 max-w-xs md:max-w-md lg:max-w-lg xl:max-w-xl bg-gray-100 text-gray-800 rounded-2xl px-4 py-2">
                            <p class="text-sm">${content}</p>
                            <p class="text-xs text-gray-500 text-right mt-1">${timeString}</p>
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Function to load chat history
        async function loadChatHistory() {
            try {
                const response = await fetch('/api/chat/history');
                if (!response.ok) throw new Error('Failed to load chat history');
                
                const messages = await response.json();
                messagesContainer.innerHTML = ''; // Clear loading state if any
                
                messages.reverse().forEach(msg => {
                    addMessage(msg.role, msg.content, msg.timestamp);
                });
                
                // If no messages, add a welcome message
                if (messages.length === 0) {
                    addMessage('assistant', 'Hello! I\'m Lumi, your AI companion. How can I help you today?');
                }
                
            } catch (error) {
                console.error('Error loading chat history:', error);
                addMessage('assistant', 'Welcome! I\'m Lumi, your AI companion. How can I help you today?');
            }
        }
        
        // Handle form submission
        messageForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Add user message to UI
            addMessage('user', message);
            messageInput.value = '';
            
            // Show typing indicator
            typingIndicator.classList.remove('hidden');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                // Check API status before sending
                await checkStatusBeforeMessage();
                
                // Send message to server
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message })
                });
                
                if (!response.ok) {
                    // Update status immediately if API call fails
                    if (response.status === 429) {
                        checkApiStatus();
                    }
                    throw new Error('Failed to send message');
                }
                
                const data = await response.json();
                
                // Hide typing indicator and add response
                typingIndicator.classList.add('hidden');
                addMessage('assistant', data.response, data.timestamp);
                
                // If we got a successful response, update status
                checkApiStatus();
                
            } catch (error) {
                console.error('Error sending message:', error);
                typingIndicator.classList.add('hidden');
                
                // Check status after error to update indicator
                checkApiStatus();
                
                // Show appropriate error message based on current status
                const statusText = document.getElementById('status-text').textContent;
                if (statusText === 'Limited Mode') {
                    addMessage('assistant', 'I\'m currently in limited mode due to API quotas, but I can still chat with you using my personality system!');
                } else if (statusText === 'Offline') {
                    addMessage('assistant', 'I\'m having trouble connecting to my AI brain right now, but I\'m still here to listen and help as best I can.');
                } else {
                    addMessage('assistant', 'Sorry, I encountered an error. Please try again in a moment.');
                }
            }
        });
        
        // Allow Shift+Enter for new line, Enter to send
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                messageForm.dispatchEvent(new Event('submit'));
            }
        });
        
        // Real-time API status checking
        let statusCheckInterval;
        let lastStatusCheck = 0;
        
        async function checkApiStatus(showLoading = false) {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            // Show loading state if requested
            if (showLoading) {
                statusDot.className = 'w-2 h-2 rounded-full bg-gray-400 mr-1 animate-spin';
                statusText.textContent = 'Checking...';
            }
            
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                lastStatusCheck = Date.now();
                
                // Update status indicator based on API health
                if (status.api_status) {
                    const geminiStatus = status.api_status.gemini;
                    const embeddingStatus = status.api_status.embeddings;
                    
                    if (geminiStatus === 'quota_exceeded' || embeddingStatus === 'quota_exceeded') {
                        statusDot.className = 'w-2 h-2 rounded-full bg-yellow-400 mr-1 animate-pulse';
                        statusText.textContent = 'Limited Mode';
                        // Check more frequently when in limited mode
                        setStatusCheckInterval(10000);
                    } else if (geminiStatus === 'working' && embeddingStatus === 'working') {
                        statusDot.className = 'w-2 h-2 rounded-full bg-green-400 mr-1 animate-pulse';
                        statusText.textContent = 'Connected';
                        // Normal check interval when working
                        setStatusCheckInterval(30000);
                    } else if (geminiStatus === 'working' || embeddingStatus === 'working') {
                        statusDot.className = 'w-2 h-2 rounded-full bg-blue-400 mr-1 animate-pulse';
                        statusText.textContent = 'Partial';
                        // More frequent checks for partial connectivity
                        setStatusCheckInterval(15000);
                    } else {
                        statusDot.className = 'w-2 h-2 rounded-full bg-red-400 mr-1';
                        statusText.textContent = 'Offline';
                        // Check frequently when offline to detect recovery
                        setStatusCheckInterval(5000);
                    }
                } else {
                    statusDot.className = 'w-2 h-2 rounded-full bg-red-400 mr-1';
                    statusText.textContent = 'Error';
                    setStatusCheckInterval(5000);
                }
                
            } catch (error) {
                console.error('Error checking API status:', error);
                statusDot.className = 'w-2 h-2 rounded-full bg-red-400 mr-1';
                statusText.textContent = 'Connection Error';
                // Check frequently when there's a connection error
                setStatusCheckInterval(5000);
            }
        }
        
        function setStatusCheckInterval(interval) {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            statusCheckInterval = setInterval(() => checkApiStatus(), interval);
        }
        
        // Check status before sending messages
        async function checkStatusBeforeMessage() {
            // Only check if last check was more than 5 seconds ago
            if (Date.now() - lastStatusCheck > 5000) {
                await checkApiStatus();
            }
        }
        
        // Initialize status checking with immediate check
        checkApiStatus(true);
        setStatusCheckInterval(30000); // Start with 30-second intervals
        
        // Load initial chat history
        loadChatHistory();
        
        // Update status when window gains focus (user returns to tab)
        window.addEventListener('focus', () => {
            checkApiStatus();
        });
    });
</script>
{% endblock %}
